<!DOCTYPE html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: hsl(0, 0%, 99%);
        }

        #hashtag,
        textarea,
        button {
            background-color: hsl(0, 0%, 99%);
            border: 2px solid #777;
        }

        ul {
            padding-left: 0;
        }

        li {
            display: flex;
            margin-left: 0;
            list-style-type: none;
        }

        li div {
            margin-left: 5px;
        }

        li div.time {
            margin-left: 5px;
            color: #333;
        }

        #submit {
            margin-top: 5px;
            background-color: #777;
            color: hsl(0, 0%, 99%);
        }

        span {
            color: #333;
        }

        input {
            margin: 3px;
        }
    </style>
</head>

<body>
    <h1>Post It!</h1>
    <div style="display: grid">
        <div><input id="username" type="text" value="user" onKeyUp="" /></div>
        <div><input id="hashtag" type="text" onKeyUp="getData()" /></div>
    </div>
    <ul id="postings"></ul>
    <div style="display: grid">
        <textarea id="text">

    </textarea>
        <button id="submit" onclick="post()">OK</button>
    </div>
    <span>v0.1</span>
    <script src="createDOM.js"></script>
    <script>
        let postings = document.getElementById("postings")
        let text = document.getElementById("text")
        text.value = ""

        function post() {
            console.log("post")
            let date = new Date()
            let hours = date.getHours()
            let minutes = date.getMinutes()
            if (date.getHours() < 10) hours = '0' + date.getHours()
            if (date.getMinutes() < 10) minutes = '0' + date.getMinutes()
            const time1 = hours + ":" + minutes

            let inputUser = document.getElementById("username")
            const user = inputUser.value
            let text2 = document.getElementById("text")
            const text = text2.value;
            createPosting(postings, user, time1, text)

            const timestamp = date.getTime()
            //const text = text2.value
            text2.value = "" // clear textarea

            // API
            //const response = await
            fetch("http://localhost:8081/api", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({ user: user, time: timestamp, text: text }),
            })

        }
        setInterval(getData, 10000)
        async function getData() {
            console.log("get data")
            let inputHashtag = document.getElementById("hashtag")
            const hashtag = inputHashtag.value.toLowerCase()
            if(hashtag.length > 0) console.log("hashtag: " + hashtag)
            const response = await fetch("http://localhost:8081/api/postings?hashtag=" + hashtag, {
                method: "GET"
            })
            //console.log(response)
            const result = await response.json()
            console.log(result)
            // Remove all child nodes from postings
            while (postings.firstChild) {
                postings.removeChild(postings.firstChild);
            }
            for (const r of result) {
                let date
                let time1
                if (r.time.length == 5) time1 = r.time
                else {
                    date = new Date(r.time)
                    let hours = date.getHours()
                    let minutes = date.getMinutes()
                    if (date.getHours() < 10) hours = '0' + date.getHours()
                    if (date.getMinutes() < 10) minutes = '0' + date.getMinutes()
                    time1 = hours + ":" + minutes
                }
                const user = r.user
                const time = time1
                const text = r.text

                createPosting(postings, user, time1, text)

            }
        }

        getData()
    </script>
</body>

</html>